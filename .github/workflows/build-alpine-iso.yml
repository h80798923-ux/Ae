name: Build BaseLinux Alpine ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev libncurses-dev \
          squashfs-tools xorriso wget cpio

    - name: Setup directories
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        mkdir -p $WORK/{rootfs,iso,kernel}

    - name: Download and extract Alpine rootfs
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        cd $WORK
        wget https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/alpine-minirootfs-3.21.0-x86_64.tar.gz
        tar -xzf alpine-minirootfs-3.21.0-x86_64.tar.gz -C rootfs

    - name: Set BaseLinux /etc/os-release
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        cat > $WORK/rootfs/etc/os-release << 'EOF'
NAME="BaseLinux"
ID=baselinux
VERSION="1.0"
VERSION_ID="1.0"
PRETTY_NAME="BaseLinux 1.0"
ANSI_COLOR="0;32"
HOME_URL="https://baselinux.example.com"
SUPPORT_URL="https://baselinux.example.com/support"
BUG_REPORT_URL="https://baselinux.example.com/bugs"
EOF

    - name: Download and build kernel
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        cd $WORK
        KERNEL_VER=6.6.15
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VER.tar.xz
        tar -xf linux-$KERNEL_VER.tar.xz
        cd linux-$KERNEL_VER
        make defconfig
        make -j$(nproc)
        make modules_install INSTALL_MOD_PATH=$WORK/kernel
        mkdir -p $WORK/kernel/boot
        cp arch/x86/boot/bzImage $WORK/kernel/boot/vmlinuz

    - name: Create initramfs
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        mkdir -p $WORK/iso/live/initramfs-temp
        cd $WORK/iso/live/initramfs-temp
        mkdir -p {bin,sbin,etc,proc,sys,usr,lib,lib64}
        cp -r ../../../kernel/lib/modules/* lib/
        find . | cpio -H newc -o | gzip > ../initrd
        cd ..
        rm -rf initramfs-temp
        cp $WORK/kernel/boot/vmlinuz $WORK/iso/live/vmlinuz

    - name: Create SquashFS
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        mksquashfs $WORK/rootfs $WORK/iso/live/filesystem.squashfs -e boot

    - name: Create GRUB config
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        cat > $WORK/iso/boot/grub/grub.cfg << 'GRUB'
set timeout=5
menuentry "BaseLinux Alpine CLI" {
 linux /live/vmlinuz boot=live quiet
 initrd /live/initrd
}
GRUB

    - name: Build ISO
      run: |
        WORK=$GITHUB_WORKSPACE/baselinux
        xorriso -as mkisofs -o $WORK/BaseLinux.iso -volid "BaseLinux" iso

    - name: Upload ISO
      uses: actions/upload-artifact@v3
      with:
        name: BaseLinux-ISO
        path: $GITHUB_WORKSPACE/baselinux/BaseLinux.iso
