name: ProjectA Linux Full Distro (XFCE)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install build tools
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev \
            wget tar xorriso grub-pc-bin grub-common mtools \
            squashfs-tools

      - name: Download Linux kernel 6.19-rc2
        run: |
          wget https://git.kernel.org/torvalds/t/linux-6.19-rc2.tar.gz
          tar -xzf linux-6.19-rc2.tar.gz

      - name: Build kernel
        run: |
          cd linux-6.19-rc2
          make defconfig
          make -j$(nproc)
          mkdir -p ../kernel
          cp arch/x86/boot/bzImage ../kernel/vmlinuz

      - name: Create root filesystem (Alpine base)
        run: |
          wget https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
          mkdir rootfs
          sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C rootfs
          sudo cp /etc/resolv.conf rootfs/etc/

      - name: Install system + XFCE
        run: |
          sudo chroot rootfs /bin/sh << 'EOF'
          apk update
          apk add \
            xorg-server \
            xinit \
            xfce4 \
            xfce4-terminal \
            dbus \
            bash \
            sudo \
            elogind \
            ttf-dejavu \
            networkmanager \
            nano

          # Branding
          echo "ProjectA Linux" > /etc/hostname

          cat > /etc/os-release << OSR
          NAME="ProjectA Linux"
          ID=projecta
          VERSION="1.0"
          PRETTY_NAME="ProjectA Linux (XFCE)"
          OSR

          # Autologin + XFCE
          echo "exec startxfce4" > /root/.xinitrc
          chmod +x /root/.xinitrc

          echo 'if [ -z "$DISPLAY" ] && [ "$(tty)" = "/dev/tty1" ]; then startx; fi' > /root/.profile

          sed -i 's/^tty1.*/tty1::respawn:\/sbin\/agetty --autologin root tty1 linux/' /etc/inittab

          # ---- TRX PACKAGE MANAGER ----
          mv /sbin/apk /sbin/apk.real

          cat > /usr/bin/trx << 'TRX'
          #!/bin/sh
          case "$1" in
            install) shift; exec /sbin/apk.real add "$@" ;;
            remove)  shift; exec /sbin/apk.real del "$@" ;;
            search)  shift; exec /sbin/apk.real search "$@" ;;
            update)         exec /sbin/apk.real update ;;
            *)              exec /sbin/apk.real "$@" ;;
          esac
          TRX
          chmod +x /usr/bin/trx

          cat > /usr/bin/apk << 'APK'
          #!/bin/sh
          echo "apk devre disi."
          echo "Lutfen 'trx install <paket>' kullan."
          exit 1
          APK
          chmod +x /usr/bin/apk
          EOF

      - name: Create squashfs
        run: |
          sudo mksquashfs rootfs filesystem.squashfs -comp xz

      - name: Prepare ISO structure
        run: |
          mkdir -p iso/boot/grub
          cp kernel/vmlinuz iso/boot/vmlinuz
          cp filesystem.squashfs iso/boot/filesystem.squashfs

      - name: GRUB config
        run: |
          cat > iso/boot/grub/grub.cfg << 'EOF'
          set timeout=3
          set default=0

          menuentry "ProjectA Linux (XFCE)" {
            echo "ProjectA tarafindan yapildi"
            linux /boot/vmlinuz quiet
          }
          EOF

      - name: Build ISO
        run: |
          grub-mkrescue -o ProjectA-Linux-XFCE.iso iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: ProjectA-Linux-Full
          path: ProjectA-Linux-XFCE.iso
