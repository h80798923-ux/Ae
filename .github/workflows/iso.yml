name: TrixieOS Live ISO (XFCE Root)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            wget tar xorriso grub-pc-bin grub-common mtools \
            squashfs-tools

      - name: Download Alpine minirootfs
        run: |
          wget https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz

      - name: Extract rootfs
        run: |
          mkdir rootfs
          sudo tar -xzf alpine-minirootfs-3.23.2-x86_64.tar.gz -C rootfs
          sudo cp /etc/resolv.conf rootfs/etc/

      - name: Configure TrixieOS XFCE (root only)
        run: |
          sudo chroot rootfs /bin/sh << 'EOF'
          apk update
          apk add \
            xorg-server \
            xinit \
            xfce4 \
            xfce4-terminal \
            dbus \
            ttf-dejavu \
            bash

          echo "TrixieOS" > /etc/hostname

          cat > /etc/os-release << OSR
          NAME="TrixieOS"
          ID=trixieos
          VERSION="0.3"
          PRETTY_NAME="TrixieOS Live (XFCE)"
          OSR

          echo "exec startxfce4" > /root/.xinitrc
          chmod +x /root/.xinitrc

          echo 'if [ -z "$DISPLAY" ] && [ "$(tty)" = "/dev/tty1" ]; then startx; fi' > /root/.profile

          sed -i 's/^tty1.*/tty1::respawn:\/sbin\/agetty --autologin root tty1 linux/' /etc/inittab
          EOF

      - name: Create squashfs
        run: |
          sudo mksquashfs rootfs filesystem.squashfs -comp xz

      - name: Download kernel + initramfs
        run: |
          wget https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-netboot-3.23.2-x86_64.tar.gz
          mkdir netboot
          tar -xzf alpine-netboot-3.23.2-x86_64.tar.gz -C netboot

      - name: Prepare ISO tree
        run: |
          mkdir -p iso/boot/grub
          cp netboot/boot/vmlinuz-lts iso/boot/vmlinuz
          cp netboot/boot/initramfs-lts iso/boot/initrd
          cp filesystem.squashfs iso/boot/filesystem.squashfs

      - name: GRUB config
        run: |
          cat > iso/boot/grub/grub.cfg << 'EOF'
          set timeout=3
          set default=0

          menuentry "TrixieOS Live (XFCE)" {
            linux /boot/vmlinuz alpine_dev=ramdisk quiet
            initrd /boot/initrd
          }
          EOF

      - name: Build ISO
        run: |
          grub-mkrescue -o TrixieOS-Live-XFCE.iso iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: TrixieOS-XFCE-ISO
          path: TrixieOS-Live-XFCE.iso
