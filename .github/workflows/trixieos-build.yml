name: Build TrixieOS (Real Distro)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc g++ make \
          libncurses-dev flex bison bc \
          libssl-dev libelf-dev \
          xorriso grub-pc-bin grub-efi-amd64-bin \
          wget cpio rsync xz-utils \
          libx11-dev libxft-dev libxinerama-dev \
          pkg-config

    - name: Prepare workspace
      run: |
        mkdir -p $HOME/trixieos/{kernel,busybox,rootfs,iso}
        echo "TrixieOS - ProjectA" > $HOME/trixieos/rootfs/etc/issue

    # ---------------- KERNEL ----------------
    - name: Build Linux kernel
      run: |
        cd $HOME/trixieos/kernel
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8
        make defconfig
        make -j$(nproc)
        make modules_install INSTALL_MOD_PATH=$HOME/trixieos/rootfs
        cp arch/x86/boot/bzImage $HOME/trixieos/iso/vmlinuz

    # ---------------- BUSYBOX ----------------
    - name: Build BusyBox
      run: |
        cd $HOME/trixieos/busybox
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
        make -j$(nproc)
        make CONFIG_PREFIX=$HOME/trixieos/rootfs install

    # ---------------- ROOTFS ----------------
    - name: Create root filesystem
      run: |
        ROOT=$HOME/trixieos/rootfs
        mkdir -p $ROOT/{proc,sys,dev,etc,usr/bin,boot}
        ln -s usr/bin $ROOT/bin
        ln -s usr/bin $ROOT/sbin

        cat > $ROOT/init << 'EOF'
        #!/bin/sh
        mount -t proc none /proc
        mount -t sysfs none /sys
        mount -t devtmpfs none /dev
        echo "Welcome to TrixieOS - ProjectA"
        exec /bin/sh
        EOF
        chmod +x $ROOT/init

    # ---------------- ISO ----------------
    - name: Create Live ISO
      run: |
        ISO=$HOME/trixieos/iso
        ROOT=$HOME/trixieos/rootfs

        mkdir -p $ISO/boot/grub
        cp $ROOT/init $ISO/init
        cp $ISO/vmlinuz $ISO/boot/vmlinuz

        cat > $ISO/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        menuentry "TrixieOS Live" {
          linux /boot/vmlinuz init=/init quiet
        }
        EOF

        grub-mkrescue -o TrixieOS-Live.iso $ISO

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: TrixieOS-Live.iso
