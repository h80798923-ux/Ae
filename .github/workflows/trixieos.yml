name: Build TrixieOS (Real Linux Distro)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # -------------------------------------------------
    # 1️⃣ GEREKLİ DERLEME BAĞIMLILIKLARI
    # -------------------------------------------------
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential gcc g++ make \
          bc bison flex \
          libssl-dev \
          libelf-dev elfutils zlib1g-dev \
          libncurses-dev \
          xorriso grub-pc-bin grub-efi-amd64-bin \
          squashfs-tools \
          wget curl git \
          cpio rsync \
          pkg-config \
          python3 \
          ca-certificates

    # -------------------------------------------------
    # 2️⃣ KAYNAK KLASÖRLER
    # -------------------------------------------------
    - name: Prepare directories
      run: |
        mkdir -p trixieos/{kernel,busybox,rootfs,iso}
        mkdir -p trixieos/rootfs/{bin,sbin,etc,proc,sys,usr/{bin,sbin},dev,run,tmp,root}

    # -------------------------------------------------
    # 3️⃣ VANILLA LINUX KERNEL
    # -------------------------------------------------
    - name: Build Linux kernel (vanilla)
      run: |
        cd trixieos/kernel
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.8.tar.xz
        tar -xf linux-6.6.8.tar.xz
        cd linux-6.6.8

        make defconfig
        make -j$(nproc)

        cp arch/x86/boot/bzImage ../../iso/vmlinuz

    # -------------------------------------------------
    # 4️⃣ BUSYBOX (USERLAND)
    # -------------------------------------------------
    - name: Build BusyBox
      run: |
        cd trixieos/busybox
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1

        make defconfig
        sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config

        make -j$(nproc)
        make CONFIG_PREFIX=../../rootfs install

    # -------------------------------------------------
    # 5️⃣ TEMEL SİSTEM DOSYALARI
    # -------------------------------------------------
    - name: Create base system files
      run: |
        cd trixieos/rootfs

        echo "TrixieOS" > etc/hostname
        echo "TrixieOS ProjectA tarafından yapıldı" > etc/issue

        cat > init << 'EOF'
        #!/bin/sh
        mount -t proc proc /proc
        mount -t sysfs sys /sys
        mount -t devtmpfs dev /dev
        echo "Welcome to TrixieOS"
        exec /bin/sh
        EOF
        chmod +x init

    # -------------------------------------------------
    # 6️⃣ OPENBOX + XORG (ALPINE ROOTFS ÜZERİNDEN)
    # -------------------------------------------------
    - name: Alpine bootstrap for GUI packages
      run: |
        sudo mkdir -p /alpine
        sudo wget https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-minirootfs-3.23.2-x86_64.tar.gz
        sudo tar -xf alpine-minirootfs-3.23.2-x86_64.tar. -C /alpine

        sudo chroot /alpine /bin/sh << 'EOF'
        apk add --no-cache \
          xorg-server \
          xf86-video-vesa \
          openbox \
          xterm \
          dbus \
          sudo
        EOF

        sudo rsync -a /alpine/usr trixieos/rootfs/
        sudo rsync -a /alpine/etc trixieos/rootfs/

    # -------------------------------------------------
    # 7️⃣ INITRAMFS
    # -------------------------------------------------
    - name: Create initramfs
      run: |
        cd trixieos/rootfs
        find . | cpio -o -H newc | gzip > ../iso/initramfs.gz

    # -------------------------------------------------
    # 8️⃣ GRUB + ISO (LIVE)
    # -------------------------------------------------
    - name: Build Live ISO
      run: |
        mkdir -p trixieos/iso/boot/grub

        cat > trixieos/iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        set default=0

        menuentry "TrixieOS Live" {
          linux /vmlinuz quiet
          initrd /initramfs.gz
        }
        EOF

        grub-mkrescue -o TrixieOS-Live.iso trixieos/iso

    # -------------------------------------------------
    # 9️⃣ ARTEFAKT
    # -------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: TrixieOS
        path: |
          TrixieOS-Live.iso
