name: TrixieOS Live ISO (XFCE Direct Boot)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev \
          wget tar xorriso grub-pc-bin grub-common mtools squashfs-tools \
          qemu-utils

    # =========================
    # ROOTFS (ALPINE)
    # =========================
    - name: Download Alpine minirootfs
      run: |
        wget https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-minirootfs-3.20.3-x86_64.tar.gz

    - name: Extract rootfs
      run: |
        mkdir rootfs
        sudo tar -xzf alpine-minirootfs-3.20.3-x86_64.tar.gz -C rootfs
        sudo cp /etc/resolv.conf rootfs/etc/

    # =========================
    # CONFIGURE SYSTEM
    # =========================
    - name: Configure TrixieOS (XFCE direct)
      run: |
        sudo chroot rootfs /bin/sh << 'EOF'
        apk update
        apk add --no-cache \
          linux-firmware \
          mesa-dri-gallium \
          xfce4 xfce4-terminal xfce4-panel xfce4-session \
          xorg-server xinit dbus elogind \
          networkmanager \
          lightdm lightdm-gtk-greeter \
          bash sudo udev e2fsprogs \
          ttf-dejavu

        # OS identity
        echo "TrixieOS" > /etc/hostname

        cat > /etc/os-release << OSR
        NAME="TrixieOS"
        ID=trixieos
        VERSION="1.0"
        PRETTY_NAME="TrixieOS Linux (XFCE)"
        OSR

        # OpenRC optimize (fast boot)
        rc-update add dbus default
        rc-update add elogind default
        rc-update add NetworkManager default
        rc-update add lightdm default
        rc-update del hwclock boot || true
        rc-update del crond default || true
        rc-update del syslog default || true

        # Auto login + XFCE (NO TTY)
        cat > /etc/lightdm/lightdm.conf << LDM
        [Seat:*]
        autologin-user=root
        autologin-session=xfce
        greeter-hide-users=true
        greeter-show-manual-login=false
        LDM

        echo "exec startxfce4" > /root/.xinitrc
        chmod +x /root/.xinitrc

        # Disable console login
        sed -i 's/^tty1.*/# tty1 disabled/' /etc/inittab

        EOF

    # =========================
    # KERNEL (VANILLA)
    # =========================
    - name: Build Linux Kernel (Vanilla)
      run: |
        wget https://git.kernel.org/torvalds/t/linux-6.19-rc2.tar.gz
        tar -xzf linux-6.19-rc2.tar.gz
        cd linux-6.19-rc2
        make defconfig
        make -j$(nproc)
        mkdir -p ../kernel
        cp arch/x86/boot/bzImage ../kernel/vmlinuz

    # =========================
    # INITRAMFS (FAST)
    # =========================
    - name: Create minimal initramfs
      run: |
        sudo chroot rootfs /bin/sh << 'EOF'
        mkinitfs -F -o /boot/initramfs
        EOF
        sudo cp rootfs/boot/initramfs initramfs

    # =========================
    # SQUASHFS
    # =========================
    - name: Create squashfs
      run: |
        sudo mksquashfs rootfs filesystem.squashfs -comp xz -Xbcj x86

    # =========================
    # ISO STRUCTURE
    # =========================
    - name: Prepare ISO tree
      run: |
        mkdir -p iso/boot/grub
        cp kernel/vmlinuz iso/boot/vmlinuz
        cp initramfs iso/boot/initrd
        cp filesystem.squashfs iso/boot/filesystem.squashfs

    # =========================
    # GRUB
    # =========================
    - name: GRUB config
      run: |
        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=1
        set default=0

        menuentry "TrixieOS Linux (XFCE)" {
          linux /boot/vmlinuz quiet splash
          initrd /boot/initrd
        }
        EOF

    # =========================
    # BUILD ISO
    # =========================
    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOS-XFCE.iso iso

    # =========================
    # UPLOAD
    # =========================
    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-Linux-XFCE
        path: TrixieOS-XFCE.iso
